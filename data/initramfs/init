#!/bin/sh

PATH="/usr/sbin:/usr/bin:/sbin:/bin"
NEW_ROOT=/new-root
COMMAND_LINE=$(cat /proc/cmdline)
CONSOLE=/dev/console
ROOT_LINKS="bin sbin lib lib32 lib64 boot usr opt"
ROOT_TREES="etc root home var"


do_modprobe_group() {
  local var_group="/etc/modules/$1"

  if [ -f "${var_group}" ]; then
    for module in $(cat ${var_group}); do
      echo -e "Autoloading ${module}\n"
      modprobe "${module}" > /dev/null 2>&1
    done
  fi
}

  # Clean input/output
  exec >${CONSOLE} <${CONSOLE} 2>&1
  clear
  echo "Welcome to the JustBOOT(tm) livecd"

  umask 0077

  for i in dev sys proc tmp; do
    [ ! -d "/${i}" ] && mkdir -p "/${i}"
  done

  mount -t sysfs none /sys
  mount -t proc  none /proc
  mount -t tmpfs tmpfs /dev

  echo "/sbin/modprobe" > /proc/sys/kernel/modprobe
  mdev -s && echo "/sbin/mdev" > /proc/sys/kernel/hotplug

  do_modprobe_group boot

  for x in /dev/hd*; do
    mount -t iso9660 ${x} /mnt/livecd/image
      if [ "$?" == "0" ]
        then
          CDROM=${x}
          break
      fi
  done

  if [ "${CDROM}" == "" ]
    then
      echo "FATAL --- LIVECD NOT FOUND"
      exec /bin/sh
      exit
  fi

  echo "LiveCD found in ${CDROM}"

  mount -n -t tmpfs tmpfs ${NEW_ROOT}
  for dir in dev mnt mnt/cdrom mnt/livecd mnt/livecd/image tmp mnt/gentoo sys proc; do
    mkdir ${NEW_ROOT}/${dir} && chmod 755 ${NEW_ROOT}/${dir}
  done
  
  for node in "null c 1 3" "console c 5 1" "tty1 c 4 1"; do
    mknod ${NEW_ROOT}/dev/$node
  done

  mount -t squashfs -o loop,ro /mnt/livecd/image/livecd.squashfs ${NEW_ROOT}/mnt/livecd

  ( 
  cd ${NEW_ROOT}/mnt/livecd
  echo "Copying squashfs data..." && cp -a ${ROOT_TREES} ${NEW_ROOT}
  cd ${NEW_ROOT}
  for dir in ${ROOT_LINKS}; do ln -s mnt/livecd/$dir $dir; done
  )
 
  >/proc/sys/kernel/hotplug && umount /proc /sys

  echo "Starting init"
  exec switch_root -c ${CONSOLE} ${NEW_ROOT} /sbin/init 

# AUFS method - zen-sources only    
#  mount -t squashfs -o loop,ro /mnt/livecd/image/livecd.squashfs  /mnt/livecd/static
#  mount -t tmpfs -o size=300M none /mnt/livecd/dynamic
#  mount -t aufs -o dirs=/mnt/livecd/dynamic=rw:/mnt/livecd/static=ro aufs /new-root

#  >/proc/sys/kernel/hotplug
#  umount /sys /dev /proc

#  echo "Starting init"
#  exec switch_root /new-root /sbin/init

  echo "Failed to switch root!!"
  echo "Dropping to minimal shell"
  exec /bin/sh
